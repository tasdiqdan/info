<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shifokorlar Boâ€˜limi - Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
</head>
<body>
    <div class="upload-container">
        <input type="file" id="pdfUpload">
        <button onclick="processPDF()">PDF Yuklash</button>
    </div>
    
    <div class="quiz-container" style="display: none;">
        <h2 id="questionElement"></h2>
        <div id="answerButtons"></div>
        <button id="nextButton" onclick="nextQuestion()" style="display: none;">Keyingi</button>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let userResults = [];

        async function processPDF() {
            const file = pdfUpload.files[0];
            if (!file) {
                alert("Iltimos, PDF faylni yuklang!");
                return;
            }

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async function () {
                const typedarray = new Uint8Array(reader.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let text = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    text += textContent.items.map(item => item.str).join(" ") + " ";
                }

                extractQuestions(text);
                startQuiz();
            };
        }

        function extractQuestions(text) {
            const regex = /\d+\. (.*?)\s*A: (.*?)\s*B: (.*?)\s*C: (.*?)\s*D: (.*?)(?=\s*\d+\.|$)/g;
            let allQuestions = [];
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                let answers = [
                    { text: match[2].replace("*", "").trim(), correct: match[2].includes("*") },
                    { text: match[3].replace("*", "").trim(), correct: match[3].includes("*") },
                    { text: match[4].replace("*", "").trim(), correct: match[4].includes("*") },
                    { text: match[5].replace("*", "").trim(), correct: match[5].includes("*") }
                ];
                allQuestions.push({ question: match[1], answers: shuffleArray(answers) });
            }
            
            questions = shuffleArray(allQuestions).slice(0, 50); // 50 ta tasodifiy savol tanlash
        }

        function startQuiz() {
            document.querySelector(".upload-container").style.display = "none";
            document.querySelector(".quiz-container").style.display = "block";
            correctAnswers = 0;
            userResults = [];
            currentQuestionIndex = 0;
            showQuestion();
        }

        function showQuestion() {
            resetState();
            let currentQuestion = questions[currentQuestionIndex];
            document.getElementById("questionElement").innerText = currentQuestion.question;
            currentQuestion.answers.forEach(answer => {
                const button = document.createElement("button");
                button.innerText = answer.text;
                button.classList.add("btn");
                button.addEventListener("click", () => selectAnswer(button, answer.correct));
                document.getElementById("answerButtons").appendChild(button);
            });
        }

        function resetState() {
            document.getElementById("nextButton").style.display = "none";
            document.getElementById("answerButtons").innerHTML = "";
        }

        function selectAnswer(button, isCorrect) {
            if (isCorrect) {
                correctAnswers++;
            }
            userResults.push({ question: questions[currentQuestionIndex].question, correct: isCorrect });
            document.getElementById("nextButton").style.display = "block";
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                alert(`Sizning natijangiz: ${correctAnswers}/${questions.length}`);
                location.reload();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
